--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,41 +1,72 @@
 
 pkgbase=nginx
-pkgname=(nginx nginx-src nginx-mod-geoip nginx-mod-image-filter nginx-mod-mail
-         nginx-mod-perl nginx-mod-stream nginx-mod-xslt)
-pkgver=1.28.0
+pkgname=(nginx nginx-src)
+pkgver=1.26.3
 pkgrel=1
+_tests_commit=2a607a31f583add7adfa1ac434a3f793d327ca6b
 arch=(x86_64)
 pkgdesc='Lightweight HTTP server and IMAP/POP3 proxy server'
 url='https://nginx.org'
 license=(BSD-2-Clause)
-makedepends=(git pcre2 zlib openssl gd geoip mailcap libxcrypt libxslt rsync)
+makedepends=(mercurial pcre2 zlib openssl geoip mailcap libxcrypt)
 checkdepends=(perl perl-gd perl-io-socket-ssl perl-fcgi perl-cache-memcached
               perl-cryptx memcached ffmpeg coreutils)
-source=("git+https://github.com/nginx/nginx.git#tag=release-${pkgver}"
-        "git+https://github.com/nginx/nginx-tests.git"
-        nginx.service
+source=($url/download/nginx-$pkgver.tar.gz{,.asc}
+        "hg+https://hg.nginx.org/nginx-tests#revision=${_tests_commit}"
         logrotate)
 validpgpkeys=('B0F4253373F8F6F510D42178520A9993A1C052F8'  # Maxim Dounin <mdounin@mdounin.ru>
               '43387825DDB1BB97EC36BA5D007C8D7C15D87369'  # Roman Arutyunyan <r.arutyunyan@f5.com>
               'D6786CE303D9A9022998DC6CC8464D549AF75C0A'  # Sergey Kandaurov <s.kandaurov@f5.com>
               '13C82A63B603576156E30A4EA0EA981B66B0D967') # Konstantin Pavlov <thresh@nginx.com>
-sha512sums=('1e1e5b029fcd2bf9af1a6d7910751b7d6a7f4e42fd1014139b4ad2bcf6be06acd999844a295357923d6936c3ad165406df172c129f668e76566585cd4db4548c'
+sha512sums=('cd780e495796bf7413e54a6730d11d55127b0ca6563acf5c75eb2698f62cddbbf5ba61820c57b2316c0bb789fcfd17f98a27a84b525ed50f304d1b1043ffa05d'
             'SKIP'
-            'f469b3b14def666e955abf6f2d3c68a47631cad7bee90c92039ffe5bf629aa7e32bb4250844d52c0f963740fb07bf7fea5f8887cc1d5199403f07be6214fcb8d'
+            '2c1efc38f4d36c10e7d13bb48e035246215c33213e42d733ef0c1bbbdbce71777b2430247d1c1fe922e03d10ce53c05fe555bd9fea547658e6c6d763af8d8b93'
             '2f4dfcfa711b8bcbc5918ba635f5e430ef7132e66276261ade62bb1cba016967432c8dce7f84352cb8b07dc7c6b18f09177aa3eb92c8e358b2a106c8ca142fe9')
 
+_common_flags=(
+  --with-compat
+  --with-debug
+  --with-file-aio
+  --with-http_addition_module
+  --with-http_auth_request_module
+  --with-http_dav_module
+  --with-http_degradation_module
+  --with-http_flv_module
+  --with-http_geoip_module
+  --with-http_gunzip_module
+  --with-http_gzip_static_module
+  --with-http_mp4_module
+  --with-http_random_index_module
+  --with-http_realip_module
+  --with-http_secure_link_module
+  --with-http_slice_module
+  --with-http_ssl_module
+  --with-http_stub_status_module
+  --with-http_sub_module
+  --with-http_v2_module
+  --with-http_v3_module
+  --with-mail
+  --with-mail_ssl_module
+  --with-pcre-jit
+  --with-stream
+  --with-stream_geoip_module
+  --with-stream_realip_module
+  --with-stream_ssl_module
+  --with-stream_ssl_preread_module
+  --with-threads
+)
+
 prepare() {
-  cp -r $pkgbase{,-src}
+  cp -r $pkgbase-$pkgver{,-src}
 }
 
 build() {
-  cd $pkgbase
+  cd $pkgbase-$pkgver
 
-  auto/configure \
+  ./configure \
     --prefix=/etc/nginx \
     --conf-path=/etc/nginx/nginx.conf \
     --sbin-path=/usr/bin/nginx \
-    --modules-path=/usr/lib/nginx/modules \
     --pid-path=/run/nginx.pid \
     --lock-path=/run/lock/nginx.lock \
     --user=http \
@@ -49,130 +80,40 @@
     --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
     --with-cc-opt="$CFLAGS $CPPFLAGS" \
     --with-ld-opt="$LDFLAGS" \
-    --with-compat \
-    --with-debug \
-    --with-file-aio \
-    --with-http_addition_module \
-    --with-http_auth_request_module \
-    --with-http_dav_module \
-    --with-http_degradation_module \
-    --with-http_flv_module \
-    --with-http_geoip_module=dynamic \
-    --with-http_gunzip_module \
-    --with-http_gzip_static_module \
-    --with-http_image_filter_module=dynamic \
-    --with-http_mp4_module \
-    --with-http_perl_module=dynamic \
-    --with-http_random_index_module \
-    --with-http_realip_module \
-    --with-http_secure_link_module \
-    --with-http_slice_module \
-    --with-http_ssl_module \
-    --with-http_stub_status_module \
-    --with-http_sub_module \
-    --with-http_v2_module \
-    --with-http_v3_module \
-    --with-http_xslt_module=dynamic \
-    --with-mail=dynamic \
-    --with-mail_ssl_module \
-    --with-pcre-jit \
-    --with-stream=dynamic \
-    --with-stream_geoip_module=dynamic \
-    --with-stream_realip_module \
-    --with-stream_ssl_module \
-    --with-stream_ssl_preread_module \
-    --with-threads
+    "${_common_flags[@]}"
 
   make
-  make DESTDIR="$srcdir/install" install
-
-  rsync -am \
-    --remove-source-files \
-    --include="usr/lib/nginx/modules/ngx_*geoip*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-geoip/"
-
-  rsync -am \
-    --remove-source-files \
-    --include="usr/lib/nginx/modules/ngx_*image*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-image-filter/"
-
-  rsync -am \
-    --remove-source-files \
-    --include="usr/lib/nginx/modules/ngx_*mail*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-mail/"
-
-  rsync -am \
-    --remove-source-files \
-    --include='*.3pm' \
-    --include="usr/lib/perl*/***" \
-    --include="usr/lib/nginx/modules/ngx_*perl*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-perl/"
-
-  rsync -am \
-    --remove-source-files \
-    --include="usr/lib/nginx/modules/ngx_*stream*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-stream/"
-
-  rsync -am \
-    --remove-source-files \
-    --include="usr/lib/nginx/modules/ngx_*xslt*.so" \
-    --include='*/' \
-    --exclude='*' \
-    "$srcdir/install/" "$srcdir/install-xslt/"
-
-  find "$srcdir/install/usr" -type d -empty -delete
 }
 
 check() {
   cd nginx-tests
   local _jobs=$(nproc)
   (( _jobs > 16 )) && _jobs=16
-  TEST_NGINX_BINARY="$srcdir/$pkgbase/objs/nginx" prove -j "$_jobs" .
+  TEST_NGINX_BINARY="$srcdir/$pkgbase-$pkgver/objs/nginx" prove -j "$_jobs" .
 }
 
 package_nginx() {
-  depends=('glibc' 'pcre2' 'zlib' 'openssl' 'mailcap' 'libxcrypt')
-  optdepends=(
-    'nginx-mod-geoip: GeoIP support'
-    'nginx-mod-image-filter: transform images'
-    'nginx-mod-mail: proxy IMAP, POP and SMTP protocols'
-    'nginx-mod-perl: perl variables and location handlers'
-    'nginx-mod-stream: proxy TCP/UDP data streams'
-    'nginx-mod-xslt: transform XML responses'
-  )
-  backup=('etc/nginx/fastcgi.conf'
-          'etc/nginx/fastcgi_params'
-          'etc/nginx/koi-win'
-          'etc/nginx/koi-utf'
-          'etc/nginx/nginx.conf'
-          'etc/nginx/scgi_params'
-          'etc/nginx/uwsgi_params'
-          'etc/nginx/win-utf'
-          'etc/logrotate.d/nginx')
+  depends=(glibc pcre2 zlib openssl geoip mailcap libxcrypt)
+  backup=(etc/nginx/fastcgi.conf
+          etc/nginx/fastcgi_params
+          etc/nginx/koi-win
+          etc/nginx/koi-utf
+          etc/nginx/nginx.conf
+          etc/nginx/scgi_params
+          etc/nginx/uwsgi_params
+          etc/nginx/win-utf
+          etc/logrotate.d/nginx)
 
-  cd $pkgbase
-  mv "$srcdir"/install/* "$pkgdir/"
+  cd $pkgbase-$pkgver
+  make DESTDIR="$pkgdir" install
 
   sed -e 's|\<user\s\+\w\+;|user http;|g' \
     -e '44s|html|/usr/share/nginx/html|' \
     -e '54s|html|/usr/share/nginx/html|' \
-    -e '/^events {/ i # Load all installed modules\ninclude modules.d/*.conf;\n' \
     -i "$pkgdir"/etc/nginx/nginx.conf
 
   rm "$pkgdir"/etc/nginx/*.default
   rm "$pkgdir"/etc/nginx/mime.types  # in mailcap
-
-  install -dm0755 "$pkgdir"/etc/nginx/modules.d
 
   install -d "$pkgdir"/var/lib/nginx
   install -dm700 "$pkgdir"/var/lib/nginx/proxy
@@ -184,7 +125,6 @@
   mv "$pkgdir"/etc/nginx/html/ "$pkgdir"/usr/share/nginx
 
   install -Dm644 ../logrotate "$pkgdir"/etc/logrotate.d/nginx
-  install -Dm644 ../nginx.service "$pkgdir"/usr/lib/systemd/system/nginx.service
   install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
 
   rmdir "$pkgdir"/run
@@ -201,64 +141,6 @@
   pkgdesc="Source code of nginx $pkgver, useful for building modules"
 
   install -d "$pkgdir/usr/src"
-  cp -r $pkgbase-src "$pkgdir/usr/src/nginx"
-  rm -rf "$pkgdir/usr/src/nginx/".git*
-  ln -s auto/configure "$pkgdir/usr/src/nginx/configure"
-  install -Dm644 $pkgbase/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
+  cp -r $pkgbase-$pkgver-src "$pkgdir/usr/src/nginx"
+  install -Dm644 $pkgbase-$pkgver/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
 }
-
-_package_module() {
-  modname="$1"
-  priority="${2:-20}"
-
-  mv "$srcdir/install-$modname"/* "$pkgdir/"
-  install -Dm644 $pkgbase/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
-
-  install -dm0755 "$pkgdir"/etc/nginx/modules.d
-  cd $pkgdir
-  find usr/lib/nginx/modules -type f -name \*.so \
-    | sed -e 's@^@load_module "/@' -e 's@$@";@' \
-    >> "$pkgdir/etc/nginx/modules.d/$priority-$modname.conf"
-}
-
-package_nginx-mod-geoip() {
-  pkgdesc="GeoIP module for nginx"
-  depends=($pkgbase 'geoip')
-  backup=(etc/nginx/modules.d/20-geoip.conf)
-  _package_module geoip
-}
-
-package_nginx-mod-image-filter() {
-  pkgdesc="Module for nginx that transforms images in JPEG, GIF, PNG, and WebP formats"
-  depends=($pkgbase 'gd')
-  backup=(etc/nginx/modules.d/20-image-filter.conf)
-  _package_module image-filter
-}
-
-package_nginx-mod-mail() {
-  pkgdesc="Mail module for nginx to proxy IMAP, POP3 and SMTP protocols"
-  depends=($pkgbase)
-  backup=(etc/nginx/modules.d/20-mail.conf)
-  _package_module mail
-}
-
-package_nginx-mod-perl() {
-  pkgdesc="Module for nginx to implement location and variable handlers in Perl"
-  depends=($pkgbase 'perl')
-  backup=(etc/nginx/modules.d/20-perl.conf)
-  _package_module perl
-}
-
-package_nginx-mod-stream() {
-  pkgdesc="Module for nginx to proxy TCP and UDP data streams"
-  depends=($pkgbase)
-  backup=(etc/nginx/modules.d/10-stream.conf)
-  _package_module stream 10
-}
-
-package_nginx-mod-xslt() {
-  pkgdesc="Module for nginx to transform XML responses with XSLT stylesheets"
-  depends=($pkgbase 'libxslt')
-  backup=(etc/nginx/modules.d/20-xslt.conf)
-  _package_module xslt
-}


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -1,13 +1,8 @@
-gd
 geoip
-git
 glibc
 libxcrypt
-libxslt
 mailcap
-nginx
+mercurial
 openssl
 pcre2
-perl
-rsync
 zlib

--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,13 +1,12 @@
 prepare() {
-cp -r $pkgbase{,-src}
+cp -r $pkgbase-$pkgver{,-src}
 }
 build() {
-cd $pkgbase
-auto/configure \
+cd $pkgbase-$pkgver
+./configure \
 --prefix=/etc/nginx \
 --conf-path=/etc/nginx/nginx.conf \
 --sbin-path=/usr/bin/nginx \
---modules-path=/usr/lib/nginx/modules \
 --pid-path=/run/nginx.pid \
 --lock-path=/run/lock/nginx.lock \
 --user=http \
@@ -21,78 +20,6 @@
 --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
 --with-cc-opt="$CFLAGS $CPPFLAGS" \
 --with-ld-opt="$LDFLAGS" \
---with-compat \
---with-debug \
---with-file-aio \
---with-http_addition_module \
---with-http_auth_request_module \
---with-http_dav_module \
---with-http_degradation_module \
---with-http_flv_module \
---with-http_geoip_module=dynamic \
---with-http_gunzip_module \
---with-http_gzip_static_module \
---with-http_image_filter_module=dynamic \
---with-http_mp4_module \
---with-http_perl_module=dynamic \
---with-http_random_index_module \
---with-http_realip_module \
---with-http_secure_link_module \
---with-http_slice_module \
---with-http_ssl_module \
---with-http_stub_status_module \
---with-http_sub_module \
---with-http_v2_module \
---with-http_v3_module \
---with-http_xslt_module=dynamic \
---with-mail=dynamic \
---with-mail_ssl_module \
---with-pcre-jit \
---with-stream=dynamic \
---with-stream_geoip_module=dynamic \
---with-stream_realip_module \
---with-stream_ssl_module \
---with-stream_ssl_preread_module \
---with-threads
+"${_common_flags[@]}"
 make
-make DESTDIR="$srcdir/install" install
-rsync -am \
---remove-source-files \
---include="usr/lib/nginx/modules/ngx_*geoip*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-geoip/"
-rsync -am \
---remove-source-files \
---include="usr/lib/nginx/modules/ngx_*image*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-image-filter/"
-rsync -am \
---remove-source-files \
---include="usr/lib/nginx/modules/ngx_*mail*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-mail/"
-rsync -am \
---remove-source-files \
---include='*.3pm' \
---include="usr/lib/perl*/***" \
---include="usr/lib/nginx/modules/ngx_*perl*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-perl/"
-rsync -am \
---remove-source-files \
---include="usr/lib/nginx/modules/ngx_*stream*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-stream/"
-rsync -am \
---remove-source-files \
---include="usr/lib/nginx/modules/ngx_*xslt*.so" \
---include='*/' \
---exclude='*' \
-"$srcdir/install/" "$srcdir/install-xslt/"
-find "$srcdir/install/usr" -type d -empty -delete
 }
