--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,7 +1,7 @@
 
 pkgname=apparmor
-pkgver=4.1.0
-pkgrel=1
+pkgver=4.0.3
+pkgrel=3
 pkgdesc="Mandatory Access Control (MAC) using Linux Security Module (LSM)"
 arch=(x86_64)
 url="https://gitlab.com/apparmor/apparmor"
@@ -22,7 +22,6 @@
 makedepends=(
   apache
   autoconf-archive
-  git
   libxcrypt
   python-setuptools
   ruby
@@ -31,10 +30,8 @@
 checkdepends=(
   dejagnu
   perl-locale-gettext
-  python-gobject
   python-notify2
   python-psutil
-  tk
 )
 optdepends=(
   'perl: for perl bindings'
@@ -51,17 +48,29 @@
   etc/apparmor/severity.db
 )
 source=(
-  git+$url.git#tag=v$pkgver?signed
+  https://launchpad.net/$pkgname/${pkgver%.[0-9]}/$pkgver/+download/$pkgname-$pkgver.tar.gz{,.asc}
+  fix-tests-python-3-13.patch
+  fix_php-fpm_profiles.patch
 )
-sha512sums=('90ca4a4b1e8db9006b54ca9faa9c749f80cc79e895ad7dc9b31fd9bfdc7868c7683ebeaacff63bcc0bb2fb57069f51128d965689990920509e4767d19ce72db9')
-b2sums=('47ffb0e150f264d7701b6b82871ef718dbb399c0dcb3ac6c010dcf34cf1a2eb18234e727e44652d1cc7096c9e9a25d29eb8ebdea37b170f3bfc3a88a197d63fa')
-validpgpkeys=('3ECDCBA5FB34D254961CC53F6689E64E3D3664BB'  # AppArmor Development Team (AppArmor signing key) <apparmor@lists.ubuntu.com>
-              'EDC4830FBD39AB6AC51047FB052F367018D5C3D8') # John Johansen <john@jjmx.net> <john.johansen@canonical.com>
+sha512sums=('8b1240ec56fe4f987edcda9380de685e36f4ac931772e980a8f3655dfbfd7e337a4b15227c7ceecb87d9a2bb592e466ec39912ef8f2fa59f8802464d72df8da2'
+            'SKIP'
+            '92edba450ed33c1b726581c983d17e4437fe70c7ea07b5baa90168f469a52cb4c560c7ff3d74005456f676a393700a346ffd2058576e63788fe7659b705f7b10'
+            'a70bd317a14eae6dacf1a264fac8c1a990895597f087693834ef7427db358ee616ac9ef34d4477ab945b857175db91986b4e61d2f1b615b563bb244a3e047499')
+b2sums=('715391a1fc0fb57b820a8bcebdc76ae96e436a29546b9c47019f10f4d22942431ba5c878d92bb61b47ff17012e026195b8d7d78a329cc1cc182a31bc3b512e63'
+        'SKIP'
+        'c8bb529d96ed3f00c7599fbb1d9314d2f2c8c5b15055457cd1450881aa8a5d9468d388da8965f13e6402c391918876358b93f544aeadd5caa75f58a30a1167f0'
+        'ec17a429fa6f3207bb84b132b884e75653f4100404c6b03673aad7fd268c628e3ede4d1a9dec3b00c7d35d7c4ea09e0553b65cc763fcbc9827b449f4d7122e84')
+validpgpkeys=('3ECDCBA5FB34D254961CC53F6689E64E3D3664BB') # AppArmor Development Team (AppArmor signing key) <apparmor@lists.ubuntu.com>
 _core_perl="/usr/bin/core_perl"
 
 prepare() {
-  cd $pkgname/libraries/libapparmor/
+  cd $pkgname-$pkgver
 
+  patch -Np1 -i ../fix-tests-python-3-13.patch
+
+  patch -Np1 -i ../fix_php-fpm_profiles.patch
+
+  cd libraries/libapparmor/
   autoreconf -fiv
 }
 
@@ -74,7 +83,7 @@
     --with-ruby
   )
 
-  cd $pkgname
+  cd $pkgname-$pkgver
 
   export MAKEFLAGS+=" POD2MAN=$_core_perl/pod2man"
   export MAKEFLAGS+=" POD2HTML=$_core_perl/pod2html"
@@ -94,11 +103,11 @@
   make -C utils/vim
 
   cd ..
-  cp -av $pkgname $pkgname-test
+  cp -av $pkgname-$pkgver $pkgname-$pkgver-test
 }
 
 check() {
-  cd $pkgname-test
+  cd $pkgname-$pkgver-test
   echo "INFO: Running check: libraries/libapparmor"
   make -C libraries/libapparmor check
   echo "INFO: Running check binutils"
@@ -114,7 +123,7 @@
 }
 
 package() {
-  cd $pkgname
+  cd $pkgname-$pkgver
   make -C libraries/libapparmor DESTDIR="$pkgdir" install
   make -C changehat/pam_apparmor DESTDIR="$pkgdir/usr" install
   make -C changehat/mod_apparmor DESTDIR="$pkgdir" install
@@ -129,4 +138,6 @@
   mv -v "$pkgdir/usr/lib/ruby/"{site,vendor}_ruby
   cd "$pkgdir"
   [[ /usr/bin/true ]] && backup=( ${backup[@]} $(find "etc/$pkgname.d/" -type f | LC_ALL=C sort) )
+
+  rm -r $pkgdir/usr/lib/systemd
 }


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -3,7 +3,6 @@
 autoconf-archive
 bash
 gcc-libs
-git
 glibc
 libxcrypt
 pam

--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,5 +1,8 @@
 prepare() {
-cd $pkgname/libraries/libapparmor/
+cd $pkgname-$pkgver
+patch -Np1 -i ../fix-tests-python-3-13.patch
+patch -Np1 -i ../fix_php-fpm_profiles.patch
+cd libraries/libapparmor/
 autoreconf -fiv
 }
 build() {
@@ -10,7 +13,7 @@
 --with-python
 --with-ruby
 )
-cd $pkgname
+cd $pkgname-$pkgver
 export MAKEFLAGS+=" POD2MAN=$_core_perl/pod2man"
 export MAKEFLAGS+=" POD2HTML=$_core_perl/pod2html"
 export MAKEFLAGS+=" PODCHECKER=$_core_perl/podchecker"
@@ -28,5 +31,5 @@
 make -C changehat/mod_apparmor
 make -C utils/vim
 cd ..
-cp -av $pkgname $pkgname-test
+cp -av $pkgname-$pkgver $pkgname-$pkgver-test
 }
