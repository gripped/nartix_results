--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,55 +1,48 @@
 
 pkgname=dune
-pkgver=3.21.1
-pkgrel=1
+pkgver=3.20.2
+pkgrel=2
 pkgdesc="A composable build system for OCaml (formerly jbuilder)"
 arch=(x86_64)
 url="https://github.com/ocaml/dune"
 license=('MIT')
-depends=('glibc' 'ocaml')
-makedepends=('git' 'ocaml-re' 'ocaml-compiler-libs' 'ocaml-csexp' 'ocaml-pp' 'ocaml-findlib')
-optdepends=()
-provides=('dune-configurator')
-source=("https://github.com/ocaml/dune/releases/download/${pkgver}/dune-${pkgver}.tbz")
-sha256sums=('84f7a82c6d80a7124f3847e9a489e80cfbeafb7bed3573ac01286ef56fd08d94')
+depends=('glibc')
+makedepends=('git' 'ocaml' 'ocaml-compiler-libs' 'ocaml-csexp' 'ocaml-pp' 'ocaml-findlib')
+optdepends=('ocaml: Dune standard library')
+source=("git+https://github.com/ocaml/dune.git#tag=$pkgver")
+b2sums=('e42172e2ba896bb034630604a1523836e74bb3c4d766039f0f07986ca58da2c29d30954d653fdbb501117c020645c0115664458047dc9de7e7413b455d3d5e95')
 
-_dune_release_pkgs=(
-    'dune'
-    'dune-action-plugin'
-    'dune-build-info'
-    'dune-configurator'
-    'dune-glob'
-    'dune-private-libs'
-    'dune-rpc'
-    'dune-site'
-    'chrome-trace'
-    'dyn'
-    'fs-io'
-    'ordering'
-    'stdune'
-    'xdg'
-    'top-closure'
-    'ocamlc-loc'
-)
+_dune_release_pkgs=('dune' 'dune-action-plugin' 'dune-build-info' 'dune-configurator' 'dune-glob' 'dune-private-libs'
+                    'dune-site' 'dune-rpc' 'dyn' 'stdune' 'ordering' 'xdg' 'chrome-trace' 'ocamlc-loc')
+
 build() {
-    cd "${srcdir}/dune-${pkgver}"
-    ./configure --prefix=/usr --libdir=/usr/lib/ocaml
-    make ./_boot/dune.exe
-    ./_boot/dune.exe build @install -p $(printf '%s,' "${_dune_release_pkgs[@]}" | sed 's/,$//') --profile dune-bootstrap
+    cd dune
+
+    ./configure --libdir /usr/lib/ocaml
+
+    make _boot/dune.exe  # this runs `ocaml bootstrap.ml`, but keeps upstream's choice
+
+    local dune_release_pkgs='dummy'
+    for _pkg in "${_dune_release_pkgs[@]}"; do
+      dune_release_pkgs+=",${_pkg}"
+    done
+    dune_release_pkgs="${dune_release_pkgs#dummy,}"
+    echo "Building packages: ${dune_release_pkgs}"
+
+    ./dune.exe build -p "${dune_release_pkgs}" --profile dune-bootstrap
 }
 
 
 package() {
-    cd "${srcdir}/dune-${pkgver}"
+    cd dune
 
-    make install DESTDIR="${pkgdir}"
-
-    ./dune.exe install -p $(printf '%s,' "${_dune_release_pkgs[@]}" | sed 's/,$//') --destdir="${pkgdir}" --prefix=/usr --libdir=/usr/lib/ocaml
+	for _pkg in "${_dune_release_pkgs[@]}"; do
+      ./dune.exe install "${_pkg}" --destdir="${pkgdir}" --prefix="/usr" --libdir="$(ocamlfind printconf destdir)"
+    done
 
     install -d "${pkgdir}"/usr/share
-    mv -v  "${pkgdir}"/usr/{doc,share/}
-    mv -v "${pkgdir}"/usr/{man,share/}
-
-    install -Dm644 "${srcdir}/dune-${pkgver}/LICENSE.md" \
-        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE.md"
+    mv "${pkgdir}"/usr/{doc,share/}
+    mv "${pkgdir}"/usr/{man,share/}
+    install -dm755 "${pkgdir}/usr/share/licenses/${pkgname}"
+    ln -s /usr/share/doc/pp/LICENSE.md "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
 }


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -5,4 +5,3 @@
 ocaml-csexp
 ocaml-findlib
 ocaml-pp
-ocaml-re

--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,6 +1,12 @@
 build() {
-cd "${srcdir}/dune-${pkgver}"
-./configure --prefix=/usr --libdir=/usr/lib/ocaml
-make ./_boot/dune.exe
-./_boot/dune.exe build @install -p $(printf '%s,' "${_dune_release_pkgs[@]}" | sed 's/,$//') --profile dune-bootstrap
+cd dune
+./configure --libdir /usr/lib/ocaml
+make _boot/dune.exe  # this runs `ocaml bootstrap.ml`, but keeps upstream's choice
+local dune_release_pkgs='dummy'
+for _pkg in "${_dune_release_pkgs[@]}"; do
+dune_release_pkgs+=",${_pkg}"
+done
+dune_release_pkgs="${dune_release_pkgs#dummy,}"
+echo "Building packages: ${dune_release_pkgs}"
+./dune.exe build -p "${dune_release_pkgs}" --profile dune-bootstrap
 }
