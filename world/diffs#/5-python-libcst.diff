--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,33 +1,68 @@
 
-_pkgname=LibCST
+_pkgname=libcst
 pkgname=python-libcst
-pkgver=1.4.0
-pkgrel=1
+pkgver=0.4.9
+pkgrel=5
 pkgdesc="A concrete syntax tree parser and serializer library for Python that preserves many aspects of Python's abstract syntax tree"
 arch=('x86_64')
 url='https://github.com/Instagram/LibCST'
 license=('MIT')
-depends=('glibc' 'gcc-libs' 'python' 'python-pyyaml')
-makedepends=('python-build' 'python-installer'
-             'python-setuptools-rust' 'python-setuptools-scm' 'python-wheel')
-source=("$pkgname-$pkgver.tar.gz::$url/archive/v$pkgver.tar.gz")
-sha512sums=('e95b2d30cb0273e5b723cf532f63b7b18f44c7f909a9d03331e0b7b7200bee8b635de4782071fb099609fcc4fb1c81bd5cd7ee3d44de535e2e1ad7b1363d31e0')
+depends=(
+  'glibc'
+  'gcc-libs'
+  'python'
+  'python-typing_extensions'
+  'python-typing_inspect'
+  'python-pyyaml'
+)
+makedepends=(
+  'python-build'
+  'python-installer'
+  'python-setuptools-rust'
+  'python-setuptools-scm'
+  'python-wheel'
+  'ufmt'
+)
+checkdepends=(
+  'python-hypothesis'
+  'python-hypothesmith'
+  'python-pytest'
+)
+source=("https://pypi.io/packages/source/l/libcst/libcst-$pkgver.tar.gz")
+sha512sums=('f4f6b89ae06b319d8a7ce29e3a2446318b587684adcc80fae32fd4cf4cb3744ef20e11543d38b27622b4b748df1ca4f829d23cf0327f0f4639c93a4fc118c4df')
 
+prepare() {
+  cd $_pkgname-$pkgver
+
+  sed -i 's/subprocess.check_call/subprocess.run/' libcst/codegen/generate.py
+  python -m libcst.codegen.generate all
+}
 
 build() {
   cd $_pkgname-$pkgver
 
-  SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver python -m build --wheel --no-isolation
+  python -m build --wheel --no-isolation
 }
 
+check() {
+  local pytest_options=(
+    --ignore libcst/tests/test_fuzz.py
+    --deselect libcst/metadata/tests/test_type_inference_provider.py::TypeInferenceProviderTest::test_gen_cache_0
+    --deselect libcst/metadata/tests/test_type_inference_provider.py::TypeInferenceProviderTest::test_simple_class_types_0
+    --deselect libcst/metadata/tests/test_type_inference_provider.py::TypeInferenceProviderTest::test_with_empty_cache
+  )
+  cd $_pkgname-$pkgver
+
+  pytest -vv "${pytest_options[@]}"
+}
 
 package() {
+  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
+
   cd $_pkgname-$pkgver
 
   python -m installer --destdir="$pkgdir" dist/*.whl
   install -Dm 644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
-
-  rm -rfv "$pkgdir"/usr/lib/python*/site-packages/libcst/tests/
-  rm -rfv "$pkgdir"/usr/lib/python*/site-packages/libcst/**/tests/
+  rm -frv "$pkgdir/$site_packages/$_pkgname/"{tests,metadata/tests}
 }
 


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -6,4 +6,7 @@
 python-pyyaml
 python-setuptools-rust
 python-setuptools-scm
+python-typing_extensions
+python-typing_inspect
 python-wheel
+ufmt

--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,4 +1,9 @@
+prepare() {
+cd $_pkgname-$pkgver
+sed -i 's/subprocess.check_call/subprocess.run/' libcst/codegen/generate.py
+python -m libcst.codegen.generate all
+}
 build() {
 cd $_pkgname-$pkgver
-SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver python -m build --wheel --no-isolation
+python -m build --wheel --no-isolation
 }
