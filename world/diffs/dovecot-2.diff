--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,89 +1,58 @@
 
 
 pkgname=dovecot
-pkgver=2.4.2
+pkgver=2.3.21.1
 pkgrel=3
+
 pkgdesc="An IMAP and POP3 server written with security primarily in mind"
 url="https://dovecot.org/"
 arch=('x86_64')
-license=(
-  'MIT'
-  'LGPL-2.1-only'
-)
-depends=(
-  'bzip2'
-  'expat'
-  'gcc-libs'
-  'glibc'
-  'icu'
-  'krb5'
-  'libcap'
-  'libsodium'
-  'libstemmer'
-  'libxcrypt'
-  'lz4'
-  'mariadb-libs'
-  'openssl'
-  'pam'
-  'postgresql-libs'
-  'sqlite'
-  'systemd-libs'
-  'zlib'
-  'zstd'
-)
-makedepends=(
-  'libldap'
-  'lua53'
-  'systemd'
-  'xapian-core'
-)
-optdepends=(
-  'libldap: LDAP plugin'
-  'lua53: Lua auth and push support'
-  'xapian-core: FTS flatcurve indexer'
-)
-provides=(
-  'imap-server'
-  'pop3-server'
-)
-backup=(
-  'etc/dovecot/dovecot.conf'
-  'etc/pam.d/dovecot'
-)
-install="${pkgname}.install"
-options=('!emptydirs')
-_json_lua_ver='0.1.2'
-source=(
-  "https://dovecot.org/releases/2.4/${pkgname}-${pkgver}.tar.gz"{,.sig}
-  "json-v$_json_lua_ver.lua::https://raw.githubusercontent.com/rxi/json.lua/v$_json_lua_ver/json.lua"
-  'dovecot.sysusers'
-  'dovecot.tmpfiles'
-  'dovecot.ld.so.conf'
-  'dovecot.pam'
-  'dovecot.install'
-)
-sha256sums=('2cd62e4d22b9fc1c80bd38649739950f0dbda34fbc3e62624fb6842264e93c6e'
+license=('MIT'
+         'LGPL-2.1-only')
+
+depends=('krb5' 'openssl' 'sqlite' 'mariadb-libs' 'libsodium'
+         'postgresql-libs' 'bzip2' 'lz4' 'expat' 'curl' 'pam')
+makedepends=('libcap' 'libldap' 'lua53' 'xz' 'clucene')
+optdepends=('libldap: ldap plugin'
+            'lua53: LUA auth and push support'
+            'clucene: alternative FTS indexer')
+
+provides=('imap-server' 'pop3-server')
+
+backup=('etc/pam.d/dovecot')
+
+options=('!emptydirs' '!lto')
+
+source=("https://dovecot.org/releases/2.3/${pkgname}-${pkgver}.tar.gz"{,.sig}
+        'dovecot-2.3.14-opensslv3.patch'
+        'dovecot-2.3.21.1-fixicu.patch'
+        'dovecot.sysusersd'
+        'dovecot.tmpfilesd'
+        'dovecot.ld.so.conf'
+        'dovecot.pam')
+
+sha256sums=('2d90a178c4297611088bf7daae5492a3bc3d5ab6328c3a032eb425d2c249097e'
             'SKIP'
-            'b13df59b32c77db3bec7a1619280ea77ee5014e715ccffaa4876d857e3e9ab87'
-            '068b16ab8afcc4f5cbced76269264088aed6d662db409b94bd5d22e816a869cc'
+            '356e5761dc9161283cb795e62997c807ca081f4b42b443001cce07c03c47876d'
+            '9fe66602ee7d3c180c8d65ce705464e491777bdf60550d104c825593b8e0399b'
+            'c5e3a8ffe23e5deb4f7893d9877d972347c2ee45c4ebf713de85c537e47cfcaf'
             '0b0625b1e66ca6a95d506fd00d6a68e70620c8ea28606e2528953ffb1806b08e'
             'a457a1691cfa82495fc0503bfa4b61e54b149e63400fe0f568dff2c24a3f7858'
-            'ad9245f5e916480edd67139603cbe52e7a868233075f900ab63a0ce58f03741a'
-            '2cfaade95b24639558b28c781687b32029d6566ce3ccc3999b1ff81d94674d6c')
+            'ad9245f5e916480edd67139603cbe52e7a868233075f900ab63a0ce58f03741a')
+
 validpgpkeys=(
   'E643F0BDFDCD04D9FFCB6279C948525140558AC9' # Timo Sirainen <tss@iki.fi>
   '2BE74AAB3EE754DFB9C80D3318A348AEED409DA1' # Dovecot Community Edition
-  'EF0882079FD4ED32BF8B23B2A1B09EF84EDC5219' # Dovecot Community Edition <dovecot-ce@dovecot.org>
 )
 
 prepare() {
   cd "${pkgname}-${pkgver}"
+  patch -Np1 -i ../dovecot-2.3.14-opensslv3.patch
 
-  sed -i 's:OPENSSLCONFIG=${OPENSSLCONFIG-dovecot-openssl.cnf}:OPENSSLCONFIG=${OPENSSLCONFIG-/etc/ssl/dovecot-openssl.cnf}:' doc/mkcert.sh
+  sed -i 's:OPENSSLCONFIG=${OPENSSLCONFIG-dovecot-openssl.cnf}:OPENSSLCONFIG=${OPENSSLCONFIG- /etc/ssl/dovecot-openssl.cnf}:' doc/mkcert.sh
 
+  patch -Np1 -i ../dovecot-2.3.21.1-fixicu.patch
   autoreconf -vfi
-
-  cp -v ../json-v0.1.2.lua src/lib-lua/json.lua
 }
 
 build() {
@@ -100,7 +69,9 @@
     --libexecdir=/usr/lib \
     --with-rundir=/run/dovecot \
     --with-moduledir=/usr/lib/dovecot/modules \
+    --with-systemdsystemunitdir=no \
     --disable-static \
+    --with-nss \
     --with-pam \
     --with-sqlite \
     --with-pgsql \
@@ -112,13 +83,13 @@
     --with-lua=plugin \
     --with-zlib \
     --with-bzlib \
+    --with-lzma \
     --with-lz4 \
     --with-zstd \
+    --with-lucene \
     --with-solr \
     --with-sodium \
     --with-libcap \
-    --with-stemmer \
-    --with-flatcurve \
     --with-docs
 
   sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
@@ -135,18 +106,18 @@
 
   cd "${pkgname}-${pkgver}"
   make DESTDIR="$pkgdir" install
-  install -vDm644 "${srcdir}/dovecot.sysusers" \
+  install -Dm644 "${srcdir}/dovecot.sysusersd" \
     "${pkgdir}/usr/lib/sysusers.d/dovecot.conf"
-  install -vDm644 "${srcdir}/dovecot.tmpfiles" \
+  install -Dm644 "${srcdir}/dovecot.tmpfilesd" \
     "${pkgdir}/usr/lib/tmpfiles.d/dovecot.conf"
-  install -vdm755 "${pkgdir}/etc/dovecot/conf.d"
-  rm -vf "${pkgdir}/etc/dovecot/README"
+  install -d -m755 "${pkgdir}/etc/dovecot/conf.d"
+  rm -f "${pkgdir}/etc/dovecot/README"
 
-  install -vDm755  doc/mkcert.sh "${pkgdir}/usr/lib/dovecot/mkcert.sh"
+  install -m 755  doc/mkcert.sh "${pkgdir}/usr/lib/dovecot/mkcert.sh"
 
-  install -vDm644 "${srcdir}/dovecot.ld.so.conf" "${pkgdir}/etc/ld.so.conf.d/dovecot.conf"
+  install -Dm644 "${srcdir}/dovecot.ld.so.conf" "${pkgdir}/etc/ld.so.conf.d/dovecot.conf"
 
-  install -vDm644 "${srcdir}/dovecot.pam" "${pkgdir}/etc/pam.d/dovecot"
+  install -Dm644 "${srcdir}/dovecot.pam" "${pkgdir}/etc/pam.d/dovecot"
 
-  install -vDm644 -t "${pkgdir}/usr/share/licenses/${pkgname}" COPYING.MIT
+  install -D -m644 COPYING.MIT "${pkgdir}"/usr/share/licenses/${pkgname}/COPYING.MIT
 }


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -1,14 +1,11 @@
 bzip2
+clucene
+curl
 expat
-gcc-libs
-glibc
-icu
 krb5
 libcap
 libldap
 libsodium
-libstemmer
-libxcrypt
 lua53
 lz4
 mariadb-libs
@@ -16,8 +13,4 @@
 pam
 postgresql-libs
 sqlite
-systemd
-systemd-libs
-xapian-core
-zlib
-zstd
+xz