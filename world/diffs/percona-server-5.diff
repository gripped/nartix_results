--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,42 +1,37 @@
 
 pkgbase=percona-server
 pkgname=('libperconaserverclient' 'percona-server-clients' 'percona-server')
-pkgver=8.3.0_1
+pkgver=8.1.0_1
 _boost_ver=1.77.0
 _pkgver=${pkgver/_/-}
 _myver=${pkgver/_rel*}
-pkgrel=1
+pkgrel=3
 arch=('x86_64')
-makedepends=('cmake' 'zlib' 'lz4' 'zstd' 'libaio' 'systemd-tools' 'pam' 'numactl' 'jemalloc' 'openssl'
-             'rpcsvc-proto' 'doxygen' 'graphviz' 'libevent' 'libfido2') # 'boost'
+makedepends=('cmake' 'zlib' 'lz4' 'zstd' 'libaio' 'pam' 'numactl' 'jemalloc' 'openssl'
+             'rpcsvc-proto' 'doxygen' 'graphviz' 'libevent' 'protobuf' 'libfido2') # 'boost'
 license=('GPL')
 url="https://www.percona.com/software/mysql-database/percona-server"
 source=("https://www.percona.com/downloads/Percona-Server-${pkgver%.*_*}/Percona-Server-$_pkgver/source/tarball/percona-server-$_pkgver.tar.gz"
         "https://boostorg.jfrog.io/artifactory/main/release/$_boost_ver/source/boost_${_boost_ver//./_}.tar.gz"
         'my.cnf'
         'mysql-user.conf'
-        'mysqlrouter-user.conf')
-sha256sums=('19eba27f3a82912b666f8a986bcd78ed7047bcca206307ec9f41721dd3b85848'
+        'mysqlrouter-user.conf'
+        'protobuf-23.patch')
+sha256sums=('9b85c50cc2e70cfbdb86da6ff2a7235413663f8619215a5a55831da0c3f0d8d3'
             '5347464af5b14ac54bb945dc68f1dd7c56f0dad7262816b956138fc53bcc0131'
             'b467b04d6d06152b2abc33f2a6de63fef0fc922dd5119d2ee1d07d3c1a489731'
             '5d7710fe88ec6d298175a309c0b776142397b119c468830b2865980292ed5da6'
-            '4ca7ffdcb2d1716d4f31e4c7dd314e5d76e64f13fdc67c5d81c53650b793f5e0')
+            '4ca7ffdcb2d1716d4f31e4c7dd314e5d76e64f13fdc67c5d81c53650b793f5e0'
+            '2d73c79f355eaf3c0bced0f0da6ad099323f4f489d5cddb609cf01af5a617305')
 
 prepare() {
 	cd $pkgbase-$_pkgver
 	rm -v sql/sql_yacc.{cc,h}
+	patch -p1 -i ../protobuf-23.patch
 
 	sed -r -e s@/var/run/mysqlrouter@/run/mysqlrouter@ \
 	       -e s@lib64/mysql@lib/mysql@ \
 	       -i cmake/install_layout.cmake
-
-	for svcfile in mysqld{,@}.service.in; do
-		sed '/^PrivateTmp=/ a StateDirectory=mysql mysql-files\nRuntimeDirectory=mysqld' \
-			-i scripts/systemd/$svcfile
-	done
-
-	sed '/^PrivateTmp=/ a StateDirectory=mysqlrouter\nRuntimeDirectory=mysqlrouter' \
-		-i scripts/systemd/mysqlrouter.service.in
 }
 
 build() {
@@ -52,6 +47,8 @@
 		-DBUILD_CONFIG=mysql_release \
 		-DREPRODUCIBLE_BUILD=ON \
 		-DCMAKE_INSTALL_PREFIX=/usr \
+		-DCMAKE_PREFIX_PATH=/usr \
+		-DCMAKE_INSTALL_LIBDIR=/usr/lib \
 		-DSYSCONFDIR=/etc/mysql \
 		-DMYSQL_DATADIR=/var/lib/mysql \
 		-DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \
@@ -77,6 +74,7 @@
 		-DWITH_SSL=system \
 		-DWITH_ICU=system \
 		-DWITH_LIBEVENT=system \
+		-DWITH_PROTOBUF=system \
 		-DWITH_FIDO=system \
 		-DWITH_ENCRYPTION_UDF=ON \
 		-DWITH_KEYRING_VAULT=ON \
@@ -94,7 +92,7 @@
 		-DDEBUG_EXTNAME=OFF \
 		-DBUILD_TESTING=OFF \
 		-DWITH_UNIT_TESTS=OFF \
-		-DWITH_SYSTEMD=1 \
+		-DWITH_SYSTEMD=0 \
 		-DCMAKE_EXE_LINKER_FLAGS='-ljemalloc' \
 		-DWITH_NUMA=ON \
 		-DWITH_BOOST="../boost_${_boost_ver//./_}"
@@ -142,8 +140,8 @@
 package_percona-server() {
 	pkgdesc='Drop-in replacement for MySQL that provides improved performance, diagnostics, instrumentation and MyRocks storage engine'
 	backup=('etc/mysql/my.cnf' 'etc/mysqlrouter/mysqlrouter.conf')
-	depends=('libaio' 'systemd-tools' 'pam' 'jemalloc' 'numactl' 'lz4' 'zstd' 'openssl' 'libtirpc' 'curl'
-	         'libevent' 'icu') # 'boost-libs'
+	depends=('libaio' 'pam' 'jemalloc' 'numactl' 'lz4' 'zstd' 'openssl' 'libtirpc' 'curl'
+	         'libevent' 'protobuf' 'icu') # 'boost-libs'
 	optdepends=('perl-dbd-mysql')
 	conflicts=('mysql')
 	provides=("mysql=$_myver" "mariadb=$_myver")


############# Stripped diff below #################

--- arch_depends
+++ artix_depends
@@ -13,8 +13,8 @@
 numactl
 openssl
 pam
+protobuf
 readline
 rpcsvc-proto
-systemd-tools
 zlib
 zstd

--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,15 +1,10 @@
 prepare() {
 cd $pkgbase-$_pkgver
 rm -v sql/sql_yacc.{cc,h}
+patch -p1 -i ../protobuf-23.patch
 sed -r -e s@/var/run/mysqlrouter@/run/mysqlrouter@ \
 -e s@lib64/mysql@lib/mysql@ \
 -i cmake/install_layout.cmake
-for svcfile in mysqld{,@}.service.in; do
-sed '/^PrivateTmp=/ a StateDirectory=mysql mysql-files\nRuntimeDirectory=mysqld' \
--i scripts/systemd/$svcfile
-done
-sed '/^PrivateTmp=/ a StateDirectory=mysqlrouter\nRuntimeDirectory=mysqlrouter' \
--i scripts/systemd/mysqlrouter.service.in
 }
 build() {
 mkdir -p build
@@ -23,6 +18,8 @@
 -DBUILD_CONFIG=mysql_release \
 -DREPRODUCIBLE_BUILD=ON \
 -DCMAKE_INSTALL_PREFIX=/usr \
+-DCMAKE_PREFIX_PATH=/usr \
+-DCMAKE_INSTALL_LIBDIR=/usr/lib \
 -DSYSCONFDIR=/etc/mysql \
 -DMYSQL_DATADIR=/var/lib/mysql \
 -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \
@@ -48,6 +45,7 @@
 -DWITH_SSL=system \
 -DWITH_ICU=system \
 -DWITH_LIBEVENT=system \
+-DWITH_PROTOBUF=system \
 -DWITH_FIDO=system \
 -DWITH_ENCRYPTION_UDF=ON \
 -DWITH_KEYRING_VAULT=ON \
@@ -65,7 +63,7 @@
 -DDEBUG_EXTNAME=OFF \
 -DBUILD_TESTING=OFF \
 -DWITH_UNIT_TESTS=OFF \
--DWITH_SYSTEMD=1 \
+-DWITH_SYSTEMD=0 \
 -DCMAKE_EXE_LINKER_FLAGS='-ljemalloc' \
 -DWITH_NUMA=ON \
 -DWITH_BOOST="../boost_${_boost_ver//./_}"
