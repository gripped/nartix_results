--- Arch PKGBUILD
+++ Artix PKGBUILD
@@ -1,7 +1,7 @@
 
 pkgname=python-redis
-pkgver=5.0.6
-pkgrel=1
+pkgver=5.0.1
+pkgrel=2
 pkgdesc='The Python interface to the Redis key-value store'
 arch=('any')
 url='https://github.com/redis/redis-py'
@@ -14,26 +14,34 @@
   'git'
   'python-build'
   'python-installer'
+  'python-wheel'
   'python-setuptools'
-  'python-wheel'
 )
 optdepends=(
+  'python-hiredis: faster performance via hiredis'
   'python-cryptography: OCSP certificate validation'
-  'python-hiredis: faster performance via hiredis'
   'python-pyopenssl: OCSP certificate validation'
   'python-requests: OCSP certificate validation'
 )
 checkdepends=(
-  'python-cryptography'
-  'python-hiredis'
-  'python-pyopenssl'
+  'pifpaf'
+  'redis'
   'python-pytest'
   'python-pytest-asyncio'
+  'python-hiredis'
+  'python-cryptography'
+  'python-pyopenssl'
   'python-requests'
-  'redis'
 )
-source=("$pkgname::git+$url#tag=v$pkgver")
-b2sums=('9e658d3a199cc4c4c3790be34bcf793cd42752974aa5ecbc62fad6474bd9bae394256626595e8bd412ebc12881580af928effb1328edafc2b8755187de160419')
+_commit='cc4bc1a544d1030aec1696baef2861064fa8dd1c'
+source=("$pkgname::git+$url#commit=$_commit")
+b2sums=('SKIP')
+
+pkgver() {
+  cd "$pkgname"
+
+  git describe --tags | sed 's/^v//'
+}
 
 build() {
   cd "$pkgname"
@@ -44,79 +52,17 @@
 check() {
   cd "$pkgname"
 
-  _teardown() {
-    redis-cli -p 6379 shutdown
-    redis-cli -p 6380 shutdown
-    for port in $(seq 16379 16384); do
-      redis-cli -p "$port" shutdown;
-    done
-    rm -rf cluster
-  }
-  trap '_teardown' EXIT
-
-  redis-server \
-    --enable-debug-command yes \
-    --enable-module-command yes \
-    --daemonize yes \
-    --port 6379
-  redis-server \
-    --replicaof 127.0.0.1 6379 \
-    --daemonize yes \
-    --port 6380
-
-  for port in $(seq 16379 16384); do
-    mkdir -p "cluster/$port"
-    pushd "cluster/$port"
-    redis-server \
-      --cluster-enabled yes \
-      --enable-debug-command yes \
-      --dir "$PWD" \
-      --logfile "$PWD/redis.log" \
-      --daemonize yes \
-      --port "$port"
-    popd
-  done
-  yes yes | redis-cli --cluster create \
-    127.0.0.1:16379 \
-    127.0.0.1:16380 \
-    127.0.0.1:16381 \
-    127.0.0.1:16382 \
-    127.0.0.1:16383 \
-    127.0.0.1:16384 \
-    --cluster-replicas 1
-
-  local pytest_deselect_args=(
-    --deselect=tests/test_asyncio/test_bloom.py
-    --deselect=tests/test_asyncio/test_json.py
-    --deselect=tests/test_asyncio/test_search.py
-    --deselect=tests/test_asyncio/test_timeseries.py
-    --deselect=tests/test_bloom.py
-    --deselect=tests/test_cluster.py::TestClusterRedisCommands::test_tfcall
-    --deselect=tests/test_cluster.py::TestClusterRedisCommands::test_tfunction_list
-    --deselect=tests/test_cluster.py::TestClusterRedisCommands::test_tfunction_load_delete
-    --deselect=tests/test_commands.py::TestRedisCommands::test_tfcall
-    --deselect=tests/test_commands.py::TestRedisCommands::test_tfunction_list
-    --deselect=tests/test_commands.py::TestRedisCommands::test_tfunction_load_delete
-    --deselect=tests/test_json.py
-    --deselect=tests/test_search.py
-    --deselect=tests/test_timeseries.py
-
-    --deselect tests/test_asyncio/test_cluster.py::TestRedisClusterObj::test_address_remap
-  )
-
-  pytest \
-    -m "not onlycluster and not ssl" \
-    "${pytest_deselect_args[@]}"
-
-  pytest \
-    --redis-url="redis://localhost:16379/0" \
-    -m "not onlynoncluster and not redismod and not ssl" \
-    "${pytest_deselect_args[@]}"
+  pifpaf run redis -- pytest --ignore tests/test_ssl.py || echo "Tests failed"
 }
 
 package() {
   cd "$pkgname"
 
   python -m installer --destdir="$pkgdir" dist/*.whl
-  install -Dm644 -t "$pkgdir/usr/share/licenses/$pkgname" LICENSE
+
+  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
+  install -d "$pkgdir/usr/share/licenses/$pkgname"
+  ln -s "$site_packages/${pkgname#python-}-$pkgver.dist-info/LICENSE" \
+    "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
 }
+
